/**
 * IBM Confidential OCO Source Materials IBM Business Platform: Dashboard
 * (C) Copyright IBM Corp. 2016, 2021
 *
 * The source code for this program is not published or otherwise divested of
 * its trade secrets, irrespective of what has been deposited with the U.S.
 * Copyright Office
 */

define("@dashboard-features/caActions/js/slot/calculationAction/CalculationAction",["underscore","@waca/dashboard-livewidget/js/apiHelpers/SlotAPIHelper","@waca/dashboard-common/js/core/APIFactory","@waca/dashboard-livewidget/js/widgets/livewidget/nls/StringResources","@waca/dashboard-livewidget/js/features/content/slotActions/api/SlotActionsProviderAPI"],(function(t,a,e,i,n){return function(){function o(t){this.dashboard=t.dashboardAPI,this.content=t.content,this.features=t.features,this.features.SlotActions.registerProvider("calculationAction",this.getAPI())}var r=o.prototype;return r.getSlotActionList=function(t,a){void 0===a&&(a=0);var e=[],n=this._getSupportActionContext(t,a);if(this._supportAction(n)){var o=this._createCalculationSpec(n.dataSlot,a),r=this.features["Dashboard.Icons"].getIcon("common-edit"),u=this.features["Dashboard.Icons"].getIcon("dashboard-calculate");n.isEditCalculation&&e.push({name:"editCalculation",label:i.get("toolbarActionEditCalculation"),icon:r.id,type:"Button",removeThenApplyAction:!0,actions:{apply:this._editCalculation.bind(this,n.dataSource.getId(),o.columnIds)}}),e.push({name:"calculation",label:i.get("toolbarActionCalculation"),icon:u.id,type:"Button",removeThenApplyAction:!0,actions:{apply:this._createCalculation.bind(this,n.dataSource.getId(),o.columnIds)}})}return e},r.getAPI=function(){return e.createAPI(this,[n])},r._editCalculation=function(t,a){var e=this,i=this.features["Dashboard.Transaction"].startTransaction();return this._getCalculationUI().editCalculation(t,a,i).finally((function(){e.features["Dashboard.Transaction"].endTransaction(i)}))},r._createCalculation=function(t,a){var e=this,i=this.features["Dashboard.Transaction"].startTransaction();return this._getCalculationUI().createCalculation(t,a,i).then((function(t){var a=t&&t.length>0,n=e.content.getFeature("Visualization.SmartsRecommender");return a&&n&&n.addDataItems(t.map((function(t){return{columnId:t.getId()}})),i),a})).finally((function(){e.features["Dashboard.Transaction"].endTransaction(i)}))},r._getSupportActionContext=function(t,e){var i=a.getDataSlotById(this._getVisualization(),t);if(!i)return null;var n=this._getVisualization().getDataSource();if(!n)return null;if(this._isMultiMeasureDataSlot(i,e))return null;if(!(!Number.isInteger(e)&&!Array.isArray(e))&&this._dataItemMappedToUnavailableMetadataColumn(n,i,e))return null;var o=!1,r=!(Array.isArray(e)&&e.length>1),u=this._isCalculationEnabled(i,e);if(r){var s=a.getMetadataColumnForDataSlotHasOneMappedDataItem(n,i,e);o=s&&s.isEditableCalculation()}return{isCalculationEnabled:u,isEditCalculation:o,dataSlot:i,dataSource:n,isCustomGroup:this._isCustomGroup(n,i,e),isAutoGroup:this._isAutoGroup(i)}},r._isAutoGroup=function(t){return!!(t&&t.getDataItemList()).find((function(t){return t.getBinning()}))},r._supportAction=function(t){return!!t&&(!t.isAutoGroup&&(t.isCalculationEnabled||t.isEditCalculation)&&this.dashboard.getMode()===this.dashboard.MODES.EDIT&&!t.isCustomGroup)},r._isCustomGroup=function(a,e,i){var n=this,o=[],r=e.getDataItemList();return i?Array.isArray(i)?i.forEach((function(t){o.push(r[t].getColumnId())})):o.push(r[i].getColumnId()):r.length>0&&o.push(r[0].getColumnId()),o.length>0&&t.some(o,(function(t){return n.dashboard.getFeature("DataSources.moser").isConsumerGroupColumn(a.getId(),t)}))},r._isMultiMeasureDataSlot=function(t,e){return void 0===e&&(a.isMultiMeasuresSeriesSlot(t)||a.isMultiMeasuresValueSlot(t))},r._dataItemMappedToUnavailableMetadataColumn=function(a,e,i){var n=[],o=Array.isArray(i)?i:[i],r=e.getDataItemList();return o.forEach((function(t){if(Number.isInteger(t)){if(t>=r.length)throw new Error("Invalid index to retrieve the data item from slot dataItemList");n.push(r[t])}})),t.every(n,(function(t){return null===a.getMetadataColumn(t.getColumnId())}))},r._isCalculationEnabled=function(a,e){var i=!1,n=a.getDefinition().getType();if(Number.isInteger(e)){var o=a.getDataItemList()[e],r="fact"===o.getType(),u="ordinal"===a.getDefinition().getType()&&"attribute"===o.getMetadataColumn().getType(),s="any"===a.getDefinition().getType()&&"fact"===o.getMetadataColumn().getType();return r&&!u||s}if(Array.isArray(e)&&e.length<3)if("any"===n){var l=a.getDataItemList();i=t.every(e,(function(t){return"fact"===l[t].getType()}))}else"ordinal"===n&&(i=!0);return i},r._createCalculationSpec=function(t,a){var e=[],i=t.getDataItemList();return a?Array.isArray(a)?a.forEach((function(t){e.push(i[t].getColumnId())})):e.push(i[a].getColumnId()):i.length>0&&e.push(i[0].getColumnId()),{columnIds:e}},r._getVisualization=function(){return this.visualization||(this.visualization=this.content.getFeature("Visualization")),this.visualization},r._getCalculationUI=function(){return this._uiDataSources||(this._uiDataSources=this.dashboard.getFeature("DataSources.CalculationUI")),this._uiDataSources},o}()})),define("@dashboard-features/authoringProfileBundle",(function(){}));