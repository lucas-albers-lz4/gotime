/**
 * IBM Confidential OCO Source Materials IBM Business Platform: CA Share
 * (C) Copyright IBM Corp. 2017, 2018
 *
 * The source code for this program is not published or otherwise divested of
 * its trade secrets, irrespective of what has been deposited with the U.S.
 * Copyright Office
 */

define("bi/notifications/app/n10nController",["react","react-dom","bi/content_apps/utils/GlassContextHelper","bacontentnav/utils/ContentStoreObject","jquery","bi/sharecommon/utils/translator"],function(e,t,n,i,s,a){function o(){return new Promise(function(e,t){require(["ba-react-admin/ba-react-admin.min"],function(t){e(t)},t)})}return{MAX_DISPLAY:20,PREVIEW_PANE_WIDTH:"400px",showNotificationContent:function(r){return r.glassContext.getSvc(".Notification").then(function(l){return Promise.all([l.getSpecificNotification(r.messageId),o()]).then(function(o){var d=o[0],c=o[1],u=e.createElement(c.PreviewView,{onHide:r.onHideCallback,data:d,glassContext:r.glassContext,GlassContextHelper:n,ContentStoreObject:i,StringResource:a,messageList:r.messageListView});d.unread&&l.markRead(r.messageId),s(".flyoutPane.pane-right.active").append('<div class="notificationNewSlideout"></div>'),t.unmountComponentAtNode(document.getElementsByClassName("notificationNewSlideout")[0]),u&&u.type.prototype.setOpen(),t.render(u,document.getElementsByClassName("notificationNewSlideout")[0])})["catch"](function(){})}.bind(this))},deleteNotification:function(e,t){return t.glassContext.getSvc(".Notification").then(function(t){return t.deleteNotification(e)})},getNotificationState:function(e,t){return t.glassContext.getSvc(".Notification").then(function(t){return t.getNotificationState(e)})},updateNotificationState:function(e,t){return t.glassContext.getSvc(".Notification").then(function(t){return t.updateNotificationState(e)})},getObjectProperties:function(e,t){return t.glassContext.getSvc(".Content").then(function(t){var n=t.getBaseObjectsURL()+"/"+e.reportId+"?fields=type,runInAdvancedViewer";return Promise.resolve(t.get(n,{})).then(function(t){if(t.data[0]){var n=t.data[0];return"runInAdvancedViewer"in n&&(e.runInAdvancedViewer=n.runInAdvancedViewer),"type"in n&&(e.type=n.type),e}return Promise.reject()}.bind(this))}.bind(this))}}}),define("bi/notifications/views/n10nBtnView",["bi/glass/app/NavbarButtonSlideoutController","bi/notifications/app/n10nController","bi/sharecommon/utils/translator"],function(e,t,n){"use strict";var i=e.extend({onRender:function(e){e&&(this.glassContext=e.glassContext,e.target.plugin.$el.attr("aria-live","polite")),this.glassContext.getSvc(".Notification").then(function(e){e.on("notifications:newCount",function(e){this.updateButtonText(e)}.bind(this)),e.getNewNotifications()}.bind(this))},updateButtonText:function(e){var i="",s=$(".n10n_badge");s.length>0&&(e>0?(i=e>t.MAX_DISPLAY?t.MAX_DISPLAY+"+":e,s.attr("data-badge",i),s.attr("aria-label",n.translate("notification_button_accessible_label",{count:i}))):(s.removeAttr("data-badge"),s.removeAttr("aria-label")))}});return i}),define("bi/notifications/views/legacyAppButtonView",["bi/glass/app/plugins/MenuActionInterface","bi/commons/utils/Utils"],function(e,t){"use strict";var n=e.extend({onSelectItem:function(e){var n=e.target.specItemIndex,i=e.target.plugin.itemSpec.items[n];i.tool&&t.legacyLaunch(e.glassContext,i.tool)},isItemVisible:function(e){var t=e.target.itemId,n=t.split("."),i=n[n.length-1];return"legacy_myInbox"===i||"legacy_myWatchItems"===i?this._getIsLaunchable():!1},onRender:function(e){e.glassContext.services.config.getLegacyLaunchable().then(function(e){this._setIsLaunchable(1===e)}.bind(this))},_setIsLaunchable:function(e){this.isLaunchable=e},_getIsLaunchable:function(){return this.isLaunchable}});return n}),define("bi/sharecommon/utils/simpledoT",["doT"],function(e){var t=e;return t.NOT_REPLACED="__NOT_REPLACED__",t.options={verbose:!1},t.simpleTemplate=function(n){var i=n;return t.options.verbose&&(i=n.replace(/\{\{(=[\s\S]+?(\}?)+)\}\}/g,"{{$1 || '"+t.NOT_REPLACED+"($1)'}}")),e.template(i)},t}),define("text!bi/notifications/templates/notification.html",[],function(){return'<!-- Licensed Materials - Property of IBM\n \n    IBM Cognos Products: SHARE\n \n    (C) Copyright IBM Corp. 2015, 2016\n \n    US Government Users Restricted Rights - Use, duplication or disclosure restricted by GSA ADP Schedule Contract with IBM Corp.\n-->\n<div class="n10n_flyout_pageview n10n_overlay share_message_panel">\n    <div id="share_message_list" class="share_message_panel">\n        <div class="share_message_panel_header">\n            <h2>{{=it.n10n_label}}</h2>\n        </div>\n        <div class="n10n_message_container"></div>\n    </div>\n</div>\n'}),define("text!bi/notifications/templates/emptyMessageList.html",[],function(){return'<!-- Licensed Materials - Property of IBM\n \n     IBM Cognos Products: SHARE\n \n     (C) Copyright IBM Corp. 2015\n \n   US Government Users Restricted Rights - Use, duplication or disclosure restricted by GSA ADP Schedule Contract with IBM Corp.\n-->\n<div class="emptyTableContent">\n	<div class = \'empty_notifications_illustration_128\'></div>\n\n    <div class="emptyTableText">{{=it.text}}</div>\n</div>\n'}),define("text!bi/notifications/templates/loadingMessagesPopUp.html",[],function(){return'<!-- Licensed Materials - Property of IBM\n \n     IBM Cognos Products: SHARE\n \n     (C) Copyright IBM Corp. 2015\n \n   US Government Users Restricted Rights - Use, duplication or disclosure restricted by GSA ADP Schedule Contract with IBM Corp.\n-->\n\n<div class="n10n_loading_messages_popup"></div>'}),define("text!bi/notifications/templates/messagesList.html",[],function(){return'<!-- Licensed Materials - Property of IBM\n \n     IBM Cognos Products: SHARE\n \n     (C) Copyright IBM Corp. 2015, 2016\n \n   US Government Users Restricted Rights - Use, duplication or disclosure restricted by GSA ADP Schedule Contract with IBM Corp.\n-->\n{{~it.msgs :msg:index}}\n<div class="n10n_message" id="{{=msg.id}}" aria-label="{{=msg.label}}">\n    <div class="n10n_message_inner" role="button" tabindex="0">\n        <div class="n10n_message_icon">\n            <span class="{{=msg.icon}}"> </span>\n        </div>\n\n        <div class="n10n_message_details">\n            <span class="n10n_message_subject {{=msg.read}}">\n                {{? msg.read === \'unread\'}}<strong>{{?}}\n                {{=msg.subject}}\n                {{? msg.read === \'unread\'}}</strong>{{?}}\n            </span>\n            <div class="n10n_message_sender">\n                {{=msg.sender}}\n            </div>\n            <div class="n10n_message_date">\n                {{=msg.date}}\n            </div>\n        </div>\n    </div>\n    <button class="btn n10n_delete_icon">\n    	<span class="btn-hidden-label">{{=msg.deleteLabel}}</span>\n    </button>\n</div>\n{{~}}\n'}),define("bi/notifications/views/messageListView",["bi/commons/ui/View","lodash","jquery","bi/sharecommon/utils/simpledoT","text!bi/notifications/templates/messagesList.html","bi/sharecommon/utils/translator","bi/commons/utils/Utils","bi/notifications/app/n10nController","bi/commons/utils/ContentFormatter","moment-timezone"],function(e,t,n,i,s,a,o,r,l,d){var c=500,u="L",h=e.extend({init:function(e){h.inherited("init",this,arguments),n.extend(this,e),this.timezone=this.glassContext.services.userProfile.preferences.timeZoneID,this.defaultLocale=this.glassContext.services.userProfile.preferences.contentLocale||"en-us",this.KEYS={TAB:9,ENTER:13,SPACE:32,LEFT_ARROW:37,UP_ARROW:38,RIGHT_ARROW:39,DOWN_ARROW:40}},setData:function(e){this.data=e},_setEvents:function(){this.$el.find(".n10n_message").off(".n10n").on("keydown.n10n",this._handleKeyDown.bind(this)),this.$el.find(".n10n_message_inner:not(.clickBound)").addClass("clickBound").on("primaryaction",function(e){var t=e.currentTarget.parentNode.id,n=this.$el.find(e.currentTarget.parentNode);if(!n.hasClass("selected")){var i={messageId:t,messageListView:this,glassContext:this.glassContext,onHideCallback:this.clear.bind(this)};r.showNotificationContent(i,this.slideout),this._displayAsRead(n)}}.bind(this)),this.$el.find(".n10n_delete_icon:not(.clickBound)").addClass("clickBound").on("primaryaction",function(e){var t=e.currentTarget.parentNode.id,i={messageId:t,pending:!0};if(this.glassContext.services.userProfile.preferences.accessibilityFeatures)this.glassContext.appController.showMessage(a.translate("delete_notification_confirm_message"),a.translate("delete_confirm"),"info",["ok","cancel"],void 0,function(e){"ok"===e.btn&&this._completeNotificationDelete(i)}.bind(this));else{var s=n(e.currentTarget.parentNode);s.hide(c),this.glassContext.appController.showToast(a.translate("delete_notification_message"),{type:"info",btnLabel:a.translate("delete_undo"),callback:function(){i.pending=!1,this.$el.find("#"+i.messageId).show(c)}.bind(this),newestOnTop:!0,preventDuplicates:!1,timeOut:6e3,extendedTimeOut:1e3,onHidden:function(){this._completeNotificationDelete(i)}.bind(this)})}}.bind(this))},_handleKeyDown:function(e){var t=e.keyCode||e.charCode||e.which||0;if(t===this.KEYS.UP_ARROW||t===this.KEYS.DOWN_ARROW||t===this.KEYS.LEFT_ARROW||t===this.KEYS.RIGHT_ARROW){var i,s=n(e.currentTarget);switch(t){case this.KEYS.DOWN_ARROW:case this.KEYS.RIGHT_ARROW:i=s.next(),"none"==i.css("display")&&(i=i.next());break;case this.KEYS.UP_ARROW:case this.KEYS.LEFT_ARROW:i=s.prev(),"none"==i.css("display")&&(i=i.prev())}i&&i.length>0&&i.find("div.n10n_message_inner").focus(),e.preventDefault()}n(e.target.parentNode).nextAll().length<=1&&(t===this.KEYS.DOWN_ARROW||t===this.KEYS.RIGHT_ARROW)&&this.loadMessagesCallback&&"function"==typeof this.loadMessagesCallback&&this.loadMessagesCallback(this.$el.parent())},_completeNotificationDelete:function(e){var t=this.$el.find("#"+e.messageId),n={glassContext:this.glassContext};e.pending&&r.deleteNotification(e.messageId,n).then(function(){t.remove()}.bind(this))},clear:function(){this.$el.find(".n10n_message").removeClass("selected")},_displayAsRead:function(e){e.attr("aria-label",a.translate("read_notification")),e.find("strong").contents().unwrap(),e.find(".wft_message_unread_32").addClass("wft_message_read_32").removeClass("wft_message_unread_32")},_formatContent:function(){for(var e=this.$el.find(".n10n_message_subject"),t=this.$el.find(".n10n_message_date"),n=this.$el.find(".n10n_message_sender"),i=0;i<e.length;i++)e[i]&&l.middleShortenString(e[i]),l.middleShortenString(t[i]),l.middleShortenString(n[i])},_setIcon:function(){var e=this.$el.find(".n10n_delete_icon:not(:has(svg))");o.setIcon(e,"common-remove-delete",a.translate("delete_notification"))},render:function(){for(var e=[],n=this.data||[],o=a.translate("unread_notification"),r=a.translate("read_notification"),l=a.translate("delete_message_label"),c=0;c<n.length;c++)e.push({icon:n[c].unread?"wft_message_unread_32":"wft_message_read_32",subject:t.escape(n[c].subject)||"",sender:t.escape(n[c].sender)||"",date:d(n[c].created).locale(this.defaultLocale).tz(this.timezone).format(u),read:n[c].unread?"unread":"read",id:n[c].id||"",label:n[c].unread?o:r,deleteLabel:l});var h={msgs:e},f=i.simpleTemplate(s);return this.$el.append(f(h)),this._formatContent(),this._setEvents(),this._setIcon(),Promise.resolve(this)},appendNewMessages:function(e){for(var n=[],o=e||[],r=a.translate("unread_notification"),l=a.translate("read_notification"),c=a.translate("delete_message_label"),h=0;h<o.length;h++)n.push({icon:o[h].unread?"wft_message_unread_32":"wft_message_read_32",subject:t.escape(o[h].subject)||"",sender:t.escape(o[h].sender)||"",date:d(o[h].created).locale(this.defaultLocale).tz(this.timezone).format(u),read:o[h].unread?"unread":"read",id:o[h].id||"",label:o[h].unread?r:l,deleteLabel:c});var f={msgs:n},g=i.simpleTemplate(s);this.$el.append(g(f)),this._formatContent(),this._setEvents(),this._setIcon()},prependNewMessages:function(e){for(var n=[],o=e||[],r=a.translate("unread_notification"),l=a.translate("read_notification"),c=a.translate("delete_message_label"),h=0;h<o.length;h++)n.push({icon:o[h].unread?"wft_message_unread_32":"wft_message_read_32",subject:t.escape(o[h].subject)||"",sender:t.escape(o[h].sender)||"",date:d(o[h].created).locale(this.defaultLocale).tz(this.timezone).format(u),read:o[h].unread?"unread":"read",id:o[h].id||"",label:o[h].unread?r:l,deleteLabel:c});var f={msgs:n},g=i.simpleTemplate(s);this.$el.prepend(g(f)),this._formatContent(),this._setEvents(),this._setIcon()},focusNextMessage:function(e){var t=this.$el.children().length-1;if(t>0){var n=e.next(".n10n_message");if(1==n.length)n.find(".n10n_message_inner").focus(),e=n;else{var i=e.prev(".n10n_message");1==i.length&&(i.find(".n10n_message_inner").focus(),e=i)}}return e}});return h}),define("bi/notifications/views/notificationView",["jquery","bi/sharecommon/utils/simpledoT","text!bi/notifications/templates/notification.html","text!bi/notifications/templates/emptyMessageList.html","text!bi/notifications/templates/loadingMessagesPopUp.html","bi/sharecommon/utils/translator","bi/glass/app/ContentView","bi/notifications/views/messageListView","bi/commons/utils/Utils","bi/notifications/app/n10nController","../../admin/ba-graphics/dist/illustrations-js/notifications_128"],function(e,t,n,i,s,a,o,r,l,d,c){var u=!0,h=null,f=o.extend({init:function(n){f.inherited("init",this,arguments),e.extend(this,n),this.offset=0,this.prependLoading=!1,this.currentTopUnreadId="",this.currentTopReadId="",this.isShowingEmptyMessageList=!1,this.loadingAnimation=l.getLoadingAnimation(1),this.$loadingMessagePopUp=e(t.template(s)())},setFocus:function(){this.$el.find(".n10n_message_container .n10n_message:first .n10n_message_inner").focus()},_setEvents:function(){this.offset=0;var e=this.$el.find(".n10n_message_container"),t=0,n=!1;e.on("keypress",function(e){var t=e.keyCode||e.charCode||e.which||0;32==t&&e.preventDefault()}),e.scroll(function(){var i=e.scrollTop();i>t&&!n&&i>=e[0].scrollHeight-e.innerHeight()&&(n=!0,this._checkForMoreMessages(e).then(function(){n=!1})),t=i}.bind(this))},_checkForMoreMessages:function(e){return e.find(".n10n_message:last").after(this.$loadingMessagePopUp.append(this.loadingAnimation)),this.glassContext.getSvc(".Notification").then(function(e){return e.getNotifications(d.MAX_DISPLAY,this.offset)}.bind(this)).then(function(e){return h.appendNewMessages(e),this.$loadingMessagePopUp.remove(),this.offset+=e.length,!0}.bind(this))["catch"](function(){})},_loadNewMessages:function(n){function i(t,n,s){for(var a=0;a<s.length;a++){if(s[a].id===n.currentTopUnreadId){r=a;break}if(s[a].id===n.currentTopReadId){r=a;break}}return f=f.concat(s.slice(0,r)),0===f.length?(n.prependLoading=!1,void e(".n10n_loading_messages_popup:first").remove()):void(f.length<o+d.MAX_DISPLAY?(e(".n10n_loading_messages_popup:first").remove(),n.currentTopUnreadId=f[0].id,n.prependLoading=!1,h.prependNewMessages(f)):(o+=d.MAX_DISPLAY,n.glassContext.getSvc(".Notification").then(function(e){return e.getNotifications(d.MAX_DISPLAY,o)}).then(function(e){i(o,n,e)})))}var a=this.$el.find(".n10n_message_container"),o=0,r=d.MAX_DISPLAY,c=l.getLoadingAnimation(1),u=e(t.template(s)()),f=[];this.prependLoading||(a.scrollTop(0),this.prependLoading=!0,e(".n10n_message:first").before(u.append(c)),i(o,this,n))},render:function(){var s=t.template(n),o={n10n_label:a.translate("n10n_label")};return this.$el.addClass("share_message_panel"),this.$el.html(s(o)),this._setEvents(),this.glassContext.getSvc(".Notification").then(function(n){return n.getNotifications(d.MAX_DISPLAY,this.offset).then(function(s){if(!this.isShowingEmptyMessageList&&0===s.length){var o=t.template(i)({text:a.translate("empty_notification_list")});this.$el.find(".n10n_message_container").append(o),this.isShowingEmptyMessageList=!0;var d=this.$el.find(".empty_notifications_illustration_128");l.setIcon(d,c["default"].id)}return this.isShowingEmptyMessageList&&s.length>0&&(this.$el.find(".emptyTableContent").remove(),this.isShowingEmptyMessageList=!1),this.offset+=s.length,h=new r({$el:this.$el.find(".n10n_message_container"),glassContext:this.glassContext,data:s,slideout:this.slideout,loadMessagesCallback:this._checkForMoreMessages.bind(this)}),h.render(),this._getNewTopMsgIds(),u&&(n.on("notifications:deleted",this._getNewTopMsgIds.bind(this)),n.on("notifications:read",this._getNewTopMsgIds.bind(this)),n.on("notifications:new",function(t){var n=t,i=!this.currentTopUnreadId,s=!i,o=i&&t.length,r=s&&t[0].id!==this.currentTopUnreadId&&t[0].id!==this.currentTopReadId,l=o||r;l&&e("#share_message_list").length&&!this.prependLoading&&this.glassContext.appController.showToast(a.translate("toast_new_notifications"),{type:"info",onclick:function(e){e.preventDefault(),this._loadNewMessages(n)}.bind(this),timeOut:0,extendedTimeOut:0})}.bind(this)),u=!1),this}.bind(this))}.bind(this))},_getNewTopMsgIds:function(e){this.currentTopUnreadId=this.$el.find(".n10n_message:has(.unread)").first().attr("id")||"",this.currentTopReadId=this.$el.find(".n10n_message:has(.read)").first().attr("id")||""},__setNotificationViewFirstRender:function(e){u=e}});return f}),define("js/notifications/notificationsBundle",function(){});