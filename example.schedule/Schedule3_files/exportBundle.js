function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}define("storytelling/glass/controllers/ExportAsStory",["baglass/core-client/js/core-client/errors/BaseError","baglass/core-client/js/core-client/utils/ClassFactory","underscore","gemini/app/util/ErrorUtils","gemini/app/util/CapabilityUtils","gemini/app/ui/dialogs/TemplateSelectDialog","gemini/lib/@waca/dashboard-common/dist/ui/dialogs/MessageDialog","react","react-dom","gemini/lib/@waca/dashboard-common/dist/utils/URLUtil"],(function(e,t,o,r,n,a,s,i,l,c){var p=function(e){var t=null;return e.appController.getCurrentContentView?t=e.appController.getCurrentContentView():e.appController.currentAppView.currentContentView&&(t=e.appController.currentAppView.currentContentView),t};return function(){function o(){_classCallCheck(this,o),this._contributionId="com.ibm.bi.storytelling"}return o.prototype.isItemVisible=function(e){return e.target.itemId===this._contributionId+".exportAsStory"&&(this._isBoardTypeSupported(e)&&r.hasCapability(e.glassContext,"canAuthorDashboard"))},o.prototype.onSelectItem=function(e){var t=this;if(this._contributionId+".exportAsStory"===e.target.itemId){var o=p(e.glassContext),r={type:"Exported Object"};return o.getDashboardApi().getFeature("segment").track("exportedToStory",(function(){return r})),n.hasCapabilityToSaveDashboard(e).then((function(o){if(o)return t._convertToStory(e)}))}return Promise.resolve()},o.prototype.exportAsStory=function(e,t,o,r){return this._sendRequest({context:e.context,url:t.url,name:o,overwrite:r}).then(this._onExportSuccess.bind(this,e.context)).catch(this._onExportError.bind(this)).finally(this._exportDialog.hide.bind(this._exportDialog))},o.prototype._convertToStory=function(e){return this._openStoryTypeSelectionDialog(e)},o.prototype._templateSelectDialogViewOptions=function(e){var o=this;return Promise.all([t.loadModule("storytelling/StoryLayoutGenerator")]).then((function(t){var r=t[0];return o._templateLayoutGenerator=new r({stringResources:e}),o._templateLayoutGenerator.initialize().then((function(){var e=o._templateLayoutGenerator.getTemplates("slideshow"),t=o._templateLayoutGenerator.getTemplates("panAndZoom");return o._selectedTemplateId=e[0].templateId,{action:function(){},templateModels:[{id:"slideshow",templates:e},{id:"panAndZoom",templates:t}],onSelectedLayout:function(e){return o._selectedTemplateId=e},light:!0}}))}))},o.prototype._openStoryTypeSelectionDialog=function(e){var o=this;return Promise.all([t.loadModule("storytelling/nls/StringResources"),t.loadModule("storytelling-ui/storytelling-ui.min")]).then((function(t){var r=t[0],n=t[1];return o._templateSelectDialogViewOptions(r).then((function(t){var c=function(t){var r=t.layout;return o._closeTemplateSelectDialog(),o._openSaveAsDialog({context:e,navModel:r.layout.type})};o.dialogNode=document.createElement("div"),document.body.appendChild(o.dialogNode),t.action=function(){return o._templateLayoutGenerator.getSelectedLayoutSpec(o._selectedTemplateId).then(c).catch((function(e){o._closeTemplateSelectDialog(),new s({type:"error",title:r.get("errorMessageTitle"),message:e.toString()}).render()}))},l.render(i.createElement(a,{size:"md",modalHeading:r.get("selectTemplateLabel"),primaryButtonText:r.get("selectLabel"),secondaryButtonText:r.get("cancelButton"),className:"selectLayoutDialog",hasScrollingContent:!1,hasForm:!0,onRequestSubmit:t.action,onRequestClose:function(){o._closeTemplateSelectDialog()}},i.createElement(n.StoryLayoutPicker,t)),o.dialogNode)}))}))},o.prototype._closeTemplateSelectDialog=function(){this.dialogNode&&(l.unmountComponentAtNode(this.dialogNode),document.body.removeChild(this.dialogNode),this.dialogNode=null)},o.prototype._openSaveAsDialog=function(e){var o=this,r=e.context,n=e.navModel,a=r.glassContext,s=p(a),i=s.getDashboardApi();return Promise.all([a.getSvc(".ContentDialogFactory"),t.loadModule("storytelling/nls/StringResources"),this._createStory(i,s,n),this._getAncestors(r,s.getBoardId())]).then((function(e){var t=e[0],r=e[1],n=e[2],i=e[3],l=n.model;o._exportDialog=t.createSaveAsDialog({ancestors:i,glassContext:a,defaultFileName:r.get("newDefaultStoryName",{modelName:s.boardModel.name}),service:{context:{glassContext:a,boardModel:l},save:o.exportAsStory.bind(o)}}),o._exportDialog.open(),n.status.hasOutOfBoundsWidget?a.showToast(r.get("outOfBoundsWarningMessage"),{type:"warning"}):n.status.hasEmptyExploreCards&&a.showToast(r.get("emptyExploreCardsWarningMessage"),{type:"warning"})}))},o.prototype._createStory=function(e,o,r){var n=this;return Promise.all([t.loadModule("storytelling/StoryService")]).then((function(t){return new(0,t[0])({dashboardApi:e}).createStory({boardModel:o.boardModel,layoutController:o.boardController.layoutController,targetInfo:{type:r,transition:"none"},sourceType:n.sourceType})}))},o.prototype._getAncestors=function(e,t){return function(t){return t?e.glassContext.getSvc(".Content").then((function(e){var o=e.getBaseObjectsURL()+"/"+t;return e.get(o,{data:{fields:"ancestors"}})})):Promise.resolve(null)}(t).then((function(e){return e&&e.data[0].ancestors||null}))},o.prototype._onExportSuccess=function(e,t){var o=e.glassContext.appController;o.openAppView("story",{perspective:"story",content:{perspective:"story",boardId:c.getBoardIdFromUrl(t.jqXHR.getResponseHeader("location")),isAuthoringMode:o.getCurrentContentView().isAuthoringMode}})},o.prototype._onExportError=function(t){return"cmDuplicateName"===r.getErrorCode(t.saveRequest)?Promise.reject(new e("duplicate",{isDuplicate:!0})):(r.showError(t.glassContext,t.saveRequest,t.cmSpec),Promise.resolve())},o.prototype._sendRequest=function(t){var o=t.context,r=t.url,n=t.name,a=t.overwrite,s=o.glassContext.getCoreSvc(".Ajax"),i=o.boardModel;n&&(i.name=n);var l=this._getCMSpec({spec:i,context:o});return r+=a?"?updateAction=replace":"",s.ajax({type:"post",url:r,contentType:"application/json",processData:!1,dataType:"text",data:JSON.stringify(l)}).catch((function(t){return Promise.reject(new e("saving story error",{cmSpec:l,glassContext:o.glassContext,saveRequest:t.jqXHR}))}))},o.prototype._getCMSpec=function(e){var t=e.spec,o=e.context;return{defaultName:t.name,type:this._getAssetType(o),specification:JSON.stringify(t),deploymentReferences:p(o.glassContext).dashboardApi.getFeature("dataSources.deprecated").getDeploymentReferences(),iconURI:"#common-catalog",defaultScreenTip:"story",tags:["story"]}},o.prototype._getAssetType=function(e){var t="exploration",o=p(e.glassContext).getContent();if(o.options&&o.options.config){var r=o.options.config;r.hasOwnProperty("assetType")&&(t=r.assetType)}return t},o.prototype._isBoardTypeSupported=function(e){var t=p(e.glassContext);return this.sourceType=t.getDashboardApi&&t.getDashboardApi().getType(),"dashboard"===this.sourceType?"tab"===t.boardModel.layout.type:"explore"===this.sourceType},o}()})),define("storytelling/exportBundle",(function(){}));